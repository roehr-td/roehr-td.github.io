<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centene IVR Flow Visualizer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mermaid.js for Flowchart rendering -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <!-- Panzoom for interactivity -->
    <script src="https://unpkg.com/panzoom@9.4.0/dist/panzoom.min.js"></script>
    <!-- Marked.js for Markdown parsing in AI Chat -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Custom scrollbar for sidebar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Ensure the SVG scales smoothly without distortion */
        #graph-container svg {
            max-width: none !important;
            transform-origin: center center;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans overflow-hidden">

    <div class="flex flex-col md:flex-row h-screen w-full">
        
        <!-- Left Sidebar: Details and Breakdown -->
        <aside class="w-full md:w-80 h-1/3 md:h-full bg-white border-b md:border-b-0 md:border-r border-slate-200 shadow-sm flex flex-col z-20 shrink-0">
            <!-- Header -->
            <div class="p-5 border-b border-slate-100 flex-shrink-0 bg-white">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-9 h-9 rounded-lg bg-sky-500 text-white flex items-center justify-center shadow-sm shadow-sky-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-slate-800 leading-tight">Centene IVR Flow</h1>
                        <p class="text-xs text-slate-500 font-medium">v2.026.02.16 Visualizer</p>
                    </div>
                </div>
                <p class="text-sm text-slate-500 mt-3 leading-relaxed">Interactive overview of the inbound call routing, authentication, and self-service application.</p>
            </div>
            
            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-5 space-y-6">
                <!-- Section 1 -->
                <div>
                    <h2 class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-3">1. Call Routing & Greeting</h2>
                    <div class="bg-blue-50/50 hover:bg-blue-50 transition-colors p-3.5 rounded-xl border border-blue-100/60 text-sm">
                        <p class="font-semibold text-blue-900 mb-1 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>Dynamic Welcome
                        </p>
                        <p class="text-blue-700/80 leading-snug">The system instantly identifies the target brand (e.g., Fidelis, Allwell, Buckeye) based on the dialed number and plays a customized greeting.</p>
                    </div>
                </div>

                <!-- Section 2 -->
                <div>
                    <h2 class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-3">2. Authentication</h2>
                    <div class="bg-amber-50/50 hover:bg-amber-50 transition-colors p-3.5 rounded-xl border border-amber-100/60 text-sm">
                        <p class="font-semibold text-amber-900 mb-1 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span>Two-Tier Identity Verification
                        </p>
                        <p class="text-amber-700/80 leading-snug mb-2">First, the system tries to automatically look up the caller's phone number.</p>
                        <p class="text-amber-700/80 leading-snug">If no match is found, the caller must enter their DOB, Zip Code, and Card number manually to proceed.</p>
                    </div>
                </div>

                <!-- Section 3 -->
                <div>
                    <h2 class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-3">3. Self-Service Navigation</h2>
                    <div class="bg-emerald-50/50 hover:bg-emerald-50 transition-colors p-3.5 rounded-xl border border-emerald-100/60 text-sm">
                        <p class="font-semibold text-emerald-900 mb-1 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>Account & Cards
                        </p>
                        <p class="text-emerald-700/80 leading-snug">Upon successful auth, balances are auto-fetched. The caller can then manage their account (transactions/balances) or cards (activate, PIN, replace).</p>
                    </div>
                </div>

                <!-- Section 4 -->
                <div>
                    <h2 class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-3">4. Agent Escalation</h2>
                    <div class="bg-rose-50/50 hover:bg-rose-50 transition-colors p-3.5 rounded-xl border border-rose-100/60 text-sm">
                        <p class="font-semibold text-rose-900 mb-1 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-rose-500"></span>Contextual Transfers
                        </p>
                        <p class="text-rose-700/80 leading-snug mb-2">Available during open hours. Support and Dispute requests are handled entirely via a <strong>Forward to External Number</strong> block, rather than a standard queue (Assignment and Dial).</p>
                        <p class="text-rose-700/80 leading-snug">The system dynamically computes the external phone number to route to based on the brand context and chosen language.</p>
                    </div>
                </div>
            </div>
            
            <!-- Footer tag with AI Button -->
            <div class="p-4 border-t border-slate-100 flex flex-col gap-3 bg-white flex-shrink-0">
                <button id="toggle-chat-btn" class="w-full py-2.5 px-4 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-lg font-medium text-sm shadow-sm transition-all flex items-center justify-center gap-2">
                    ✨ Ask AI about Flow
                </button>
                <p class="text-[10px] text-slate-400 font-medium uppercase tracking-widest text-center">Supports EN & SP Languages</p>
            </div>
        </aside>

        <!-- Right Main Area: Interactive Canvas -->
        <main class="flex-1 h-2/3 md:h-full relative bg-[#f1f5f9] flex flex-col overflow-hidden">
            
            <!-- Toolbar Map Controls -->
            <div class="absolute top-4 right-4 z-30 flex gap-2">
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-1 flex items-center text-slate-500">
                    <button id="zoom-in" class="p-2 hover:bg-slate-100 hover:text-sky-600 rounded transition-colors" title="Zoom In">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    </button>
                    <div class="w-px h-5 bg-slate-200 mx-1"></div>
                    <button id="zoom-out" class="p-2 hover:bg-slate-100 hover:text-sky-600 rounded transition-colors" title="Zoom Out">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                    </button>
                    <div class="w-px h-5 bg-slate-200 mx-1"></div>
                    <button id="reset" class="p-2 hover:bg-slate-100 hover:text-sky-600 rounded transition-colors" title="Reset View">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading" class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-[#f1f5f9] transition-opacity duration-300">
                <div class="w-10 h-10 border-4 border-slate-200 border-t-sky-500 rounded-full animate-spin mb-4"></div>
                <p class="text-slate-500 font-medium">Generating visual diagram...</p>
            </div>

            <!-- Chat Panel Overlay (Hidden by default) -->
            <div id="ai-chat-panel" class="absolute right-0 top-0 bottom-0 w-full md:w-96 bg-white border-l border-slate-200 shadow-2xl transform translate-x-full transition-transform duration-300 z-40 flex flex-col">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-slate-800 flex items-center gap-2">✨ IVR Assistant</h3>
                    <button id="close-chat-btn" class="text-slate-400 hover:text-slate-600 p-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-4 text-sm">
                    <div class="bg-slate-100 text-slate-800 p-3 rounded-xl rounded-tl-none self-start max-w-[85%]">
                        Hello! I'm an AI assistant with deep knowledge of this call flow. You can ask me things like: 
                        <ul class="list-disc pl-4 mt-2 text-xs">
                            <li>What happens if a caller isn't recognized?</li>
                            <li>Where does the Dispute Agent route to?</li>
                            <li>Summarize the self-service options.</li>
                        </ul>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-100 bg-white">
                    <form id="chat-form" class="flex gap-2">
                        <input type="text" id="chat-input" placeholder="Ask a question..." class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white p-2 rounded-lg transition-colors flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Graph Container (Panzoom Target) -->
            <div id="graph-wrapper" class="w-full h-full cursor-grab active:cursor-grabbing overflow-hidden">
                <div id="graph-container" class="w-full h-full flex items-center justify-center opacity-0 transition-opacity duration-700 min-w-max min-h-max p-10">
                    <!-- Mermaid will render SVG here -->
                </div>
            </div>
            
            <div class="absolute bottom-4 right-4 z-10 pointer-events-none">
                 <p class="text-xs text-slate-400 font-medium tracking-wide bg-white/70 px-2 py-1 rounded shadow-sm border border-slate-100">Drag to Pan • Scroll to Zoom</p>
            </div>

        </main>
    </div>

    <script>
        // The Mermaid Chart Definition
        const graphDefinition = `
        graph TD
            %% Styling Classes
            classDef default fill:#ffffff,stroke:#cbd5e1,stroke-width:2px,color:#0f172a,rx:8px,ry:8px;
            classDef startNode fill:#f8fafc,stroke:#94a3b8,stroke-width:2px,color:#0f172a,rx:24px,ry:24px;
            classDef routing fill:#eff6ff,stroke:#60a5fa,stroke-width:2px,color:#1e3a8a,rx:8px,ry:8px;
            classDef auth fill:#fefce8,stroke:#facc15,stroke-width:2px,color:#713f12,rx:8px,ry:8px;
            classDef fetch fill:#f0fdfa,stroke:#2dd4bf,stroke-width:2px,color:#134e4a,rx:8px,ry:8px;
            classDef menu fill:#f0fdf4,stroke:#4ade80,stroke-width:2px,color:#14532d,rx:8px,ry:8px;
            classDef action fill:#f5f3ff,stroke:#a78bfa,stroke-width:2px,color:#4c1d95,rx:8px,ry:8px;
            classDef agent fill:#fef2f2,stroke:#f87171,stroke-width:2px,color:#7f1d1d,rx:8px,ry:8px;

            %% Node Definitions
            Start["Incoming Call"]
            
            subgraph Group1 ["1. Routing & Greeting"]
                DetermineRoute{"Target Number?"}
                WelcomeDL["Delaware"]
                WelcomeFD["Fidelis"]
                WelcomeAW["Allwell"]
                WelcomeAZ["Arizona"]
                WelcomeMD["Meridian"]
                WelcomeBK["Buckeye"]
                WelcomeAB["Absolute"]
                WelcomeMain["Main"]
                
                CheckHours{"Business Hours?"}
                LangSelect["Language Selection & PIN Info"]
            end

            subgraph Group2 ["2. Authentication"]
                AutoLook["Auto-Lookup Phone #"]
                PhoneMatch{"Match Found?"}
                ManualAuth["Manual Auth:<br>DOB, Zip, Card #"]
                VerifyAuth{"Verified?"}
                NoAuthAgent["Transfer to Agent<br>Unauthenticated"]
                ExtFwd1[["Forward to External #<br>(Dynamic)"]]
                FetchData["Fetch Balance & Active Cards"]
            end

            subgraph Group3 ["3. Main Menu Navigation"]
                MainMenu{"Main Menu"}
                
                AcctMenu["Account Services"]
                CardMenu["Card Services"]
                
                PlayBal["Play Balance"]
                PlayTrans["Recent Transactions"]
                
                ActCard["Activate Card"]
                PinMgmt["Manage PIN"]
                RepCard["Replace Card"]
                PlayCards["Active Cards List"]
                
                GenAgent["Support Agent"]
                DisputeAgent["Dispute Agent"]
                ExtFwd2[["Forward to External #<br>(Dynamic)"]]
            end

            %% Paths
            Start --> DetermineRoute
            
            DetermineRoute -->|"Delaware"| WelcomeDL
            DetermineRoute -->|"Fidelis"| WelcomeFD
            DetermineRoute -->|"Allwell"| WelcomeAW
            DetermineRoute -->|"Arizona"| WelcomeAZ
            DetermineRoute -->|"Meridian"| WelcomeMD
            DetermineRoute -->|"Buckeye"| WelcomeBK
            DetermineRoute -->|"Absolute"| WelcomeAB
            DetermineRoute -->|"Other"| WelcomeMain

            WelcomeDL & WelcomeFD & WelcomeAW & WelcomeAZ & WelcomeMD & WelcomeBK & WelcomeAB & WelcomeMain --> CheckHours
            
            CheckHours --> LangSelect
            LangSelect --> AutoLook
            
            AutoLook --> PhoneMatch
            PhoneMatch -->|"No"| ManualAuth
            PhoneMatch -->|"Yes"| FetchData
            
            ManualAuth --> VerifyAuth
            VerifyAuth -->|"No"| NoAuthAgent
            NoAuthAgent --> ExtFwd1
            VerifyAuth -->|"Yes"| FetchData
            
            FetchData --> MainMenu
            
            MainMenu -->|"Press 1<br>Account"| AcctMenu
            MainMenu -->|"Press 2<br>Support"| GenAgent
            MainMenu -->|"Press 3<br>Cards"| CardMenu
            MainMenu -->|"Press 4/5<br>Disputes"| DisputeAgent
            
            AcctMenu --> PlayBal
            AcctMenu --> PlayTrans
            
            CardMenu --> ActCard
            CardMenu --> PinMgmt
            CardMenu --> RepCard
            CardMenu --> PlayCards

            GenAgent --> ExtFwd2
            DisputeAgent --> ExtFwd2

            %% Apply Classes globally to prevent parsing errors
            class Start startNode;
            class DetermineRoute,CheckHours routing;
            class WelcomeDL,WelcomeFD,WelcomeAW,WelcomeAZ,WelcomeMD,WelcomeBK,WelcomeAB,WelcomeMain default;
            class LangSelect,MainMenu,AcctMenu,CardMenu menu;
            class AutoLook,PhoneMatch,ManualAuth,VerifyAuth auth;
            class NoAuthAgent,GenAgent,DisputeAgent,ExtFwd1,ExtFwd2 agent;
            class FetchData fetch;
            class PlayBal,PlayTrans,ActCard,PinMgmt,RepCard,PlayCards action;
        `;

        // Configure Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'base',
            themeVariables: {
                fontFamily: 'ui-sans-serif, system-ui, -apple-system, sans-serif',
                primaryColor: '#ffffff',
                primaryBorderColor: '#cbd5e1',
                lineColor: '#64748b',
                textColor: '#0f172a',
                clusterBkg: '#f8fafc',
                clusterBorder: '#e2e8f0'
            },
            flowchart: {
                curve: 'basis', // Smooth curves
                nodeSpacing: 50,
                rankSpacing: 50,
                padding: 20
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Render the Mermaid diagram
                const { svg } = await mermaid.render('mermaid-svg', graphDefinition);
                const container = document.getElementById('graph-container');
                container.innerHTML = svg;

                // Adjust SVG for proper zooming
                const svgElement = container.querySelector('svg');
                svgElement.setAttribute('width', '100%');
                svgElement.setAttribute('height', '100%');
                svgElement.style.maxWidth = 'none';

                // Initialize Panzoom
                const pz = panzoom(svgElement, {
                    maxZoom: 5,
                    minZoom: 0.2,
                    bounds: true,
                    boundsPadding: 0.2,
                    smoothScroll: false
                });

                // Set up controls
                document.getElementById('zoom-in').addEventListener('click', () => pz.zoomTo(container.clientWidth / 2, container.clientHeight / 2, 1.25));
                document.getElementById('zoom-out').addEventListener('click', () => pz.zoomTo(container.clientWidth / 2, container.clientHeight / 2, 0.8));
                document.getElementById('reset').addEventListener('click', () => {
                    pz.moveTo(0, 0);
                    pz.zoomAbs(0, 0, 1);
                });

                // Hide loader and show graph
                setTimeout(() => {
                    document.getElementById('loading').style.opacity = '0';
                    container.style.opacity = '1';
                    setTimeout(() => document.getElementById('loading').style.display = 'none', 300);
                }, 200);

            } catch (error) {
                console.error("Error rendering graph:", error);
                document.getElementById('loading').innerHTML = `<p class="text-red-500 font-medium">Failed to render diagram.</p>`;
            }
        });

        // --- AI Chatbot Integration using Gemini API ---
        const apiKey = "";
        const chatPanel = document.getElementById('ai-chat-panel');
        const toggleChatBtn = document.getElementById('toggle-chat-btn');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');

        let chatHistory = [];

        // Toggle Chat UI
        toggleChatBtn.addEventListener('click', () => chatPanel.classList.remove('translate-x-full'));
        closeChatBtn.addEventListener('click', () => chatPanel.classList.add('translate-x-full'));

        // Add Message to UI
        function appendMessage(text, isUser = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `p-3 rounded-xl max-w-[85%] ${isUser ? 'bg-purple-600 text-white rounded-tr-none self-end' : 'bg-slate-100 text-slate-800 rounded-tl-none self-start'}`;
            
            if (isUser) {
                msgDiv.innerText = text;
            } else {
                // Parse markdown for AI responses
                msgDiv.innerHTML = marked.parse(text);
                // Style nested elements generated by Markdown nicely
                msgDiv.querySelectorAll('p').forEach(p => p.classList.add('mb-2', 'last:mb-0'));
                msgDiv.querySelectorAll('ul').forEach(ul => ul.classList.add('list-disc', 'pl-4', 'mb-2'));
                msgDiv.querySelectorAll('ol').forEach(ol => ol.classList.add('list-decimal', 'pl-4', 'mb-2'));
            }
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Add Loading Indicator
        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'bg-slate-100 text-slate-500 p-3 rounded-xl rounded-tl-none self-start max-w-[85%] flex gap-1 items-center h-10';
            typingDiv.innerHTML = '<div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div><div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>';
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingDiv = document.getElementById('typing-indicator');
            if (typingDiv) typingDiv.remove();
        }

        // Call Gemini API
        async function askGemini(userText) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const systemPrompt = `You are an expert IVR and contact center architect. You are acting as an AI assistant helping a user understand their call flow visualizer.
Here is the Mermaid.js graph definition of the flow they are looking at:

${graphDefinition}

Answer the user's questions about this flow accurately, concisely, and clearly. Keep answers brief unless asked for details. Use markdown for formatting.`;

            chatHistory.push({ role: "user", parts: [{ text: userText }] });

            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: chatHistory
            };

            const retries = 5;
            const delays = [1000, 2000, 4000, 8000, 16000];

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || `HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (aiText) {
                        chatHistory.push({ role: "model", parts: [{ text: aiText }] });
                        return aiText;
                    } else {
                        throw new Error("Empty response from AI");
                    }
                } catch (e) {
                    if (i === retries - 1) {
                        console.error("Gemini API Error:", e);
                        return "Sorry, I encountered an error connecting to the AI service. Please try again later.";
                    }
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }

        // Handle Chat Submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (!text) return;

            // Update UI
            appendMessage(text, true);
            chatInput.value = '';
            chatInput.disabled = true;
            addTypingIndicator();

            // Fetch AI Response
            const aiResponse = await askGemini(text);

            // Update UI with response
            removeTypingIndicator();
            appendMessage(aiResponse, false);
            chatInput.disabled = false;
            chatInput.focus();
        });
    </script>
</body>
</html>
